#!/usr/bin/env bash
set -euo pipefail

# Carrega o ambiente do husky
. "$(dirname "$0")/_/husky.sh"

# Cores para output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# FunÃ§Ã£o para executar comandos com tratamento de erro
execute_step() {
  local step_name="$1"
  local command_to_run="$2"
  
  echo -e "${BLUE}â„¹ï¸  ${step_name}...${NC}"
  
  if eval "${command_to_run}" 2>&1; then
    echo -e "${GREEN}âœ… ${step_name} concluÃ­do com sucesso!${NC}"
    return 0
  else
    local exit_code=$?
    echo -e "${RED}âŒ Erro durante ${step_name} (cÃ³digo: ${exit_code})${NC}"
    return 1
  fi
}

echo -e "${BLUE}ğŸš€ Iniciando verificaÃ§Ãµes de pre-push...${NC}"

# 1. VerificaÃ§Ã£o de dependÃªncias
if ! command -v yarn >/dev/null 2>&1; then
  echo -e "${RED}âŒ Erro: Yarn nÃ£o encontrado. Por favor, instale o Yarn.${NC}"
  exit 1
fi

# 2. VerificaÃ§Ã£o de tipos TypeScript
execute_step "Verificando tipos TypeScript" "yarn type-check" || exit 1

# 3. Testes unitÃ¡rios
execute_step "Executando testes unitÃ¡rios" "yarn test:unit" || exit 1

# 4. Build do projeto
echo -e "${BLUE}â„¹ï¸  Realizando build do projeto...${NC}"
if ! output=$(timeout 120s yarn build 2>&1); then
  echo -e "${RED}âŒ Erro durante o build do projeto (ou timeout)${NC}"
  echo "${output}"
  echo -e "${YELLOW}ğŸ’¡ Dica: Tente executar 'yarn build' localmente para mais detalhes${NC}"
  exit 1
fi

echo -e "${GREEN}âœ… Build do projeto concluÃ­do com sucesso!${NC}"

# 4. VerificaÃ§Ãµes de seguranÃ§a (opcional - remover se nÃ£o for necessÃ¡rio)
# execute_step "Executando verificaÃ§Ãµes de seguranÃ§a" "yarn security:check && yarn security:audit" || exit 1

echo -e "\n${GREEN}ğŸ‰ Todas as verificaÃ§Ãµes foram concluÃ­das com sucesso!${NC}"