#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üöÄ Iniciando verifica√ß√µes de pre-commit...${NC}"

# Verificar segredos e informa√ß√µes sens√≠veis
echo -e "${BLUE}üîí Verificando segredos e informa√ß√µes sens√≠veis...${NC}"
npm run security:check || {
  echo -e "${RED}‚ùå Detectados segredos ou informa√ß√µes sens√≠veis no c√≥digo${NC}"
  exit 1
}

# Verificar se h√° altera√ß√µes em arquivos de implementa√ß√£o ou teste
if git diff --cached --name-only | grep -E "\.(ts|tsx|js|jsx)$" | grep -vE "\.(test|spec)\.(ts|tsx|js|jsx)$"; then
  echo -e "${YELLOW}‚ö†Ô∏è  Detectadas altera√ß√µes em arquivos de implementa√ß√£o. Executando testes relacionados...${NC}"
  CHANGED_FILES=$(git diff --cached --name-only | grep -E "\.(ts|tsx|js|jsx)$" | grep -vE "\.(test|spec)\.(ts|tsx|js|jsx)$" | tr '\n' ' ')
  npm test -- --findRelatedTests $CHANGED_FILES
elif git diff --cached --name-only | grep -E "\.(test|spec)\.(ts|tsx|js|jsx)$"; then
  echo -e "${YELLOW}‚ö†Ô∏è  Detectadas altera√ß√µes em arquivos de teste. Executando suite de testes completa...${NC}"
  npm run test:unit
else
  echo -e "${BLUE}‚ÑπÔ∏è  Nenhuma altera√ß√£o que afete os testes detectada.${NC}"
fi

# Executar lint-staged
echo -e "${BLUE}üîç Executando lint-staged...${NC}"
npx lint-staged

# Verificar se h√° altera√ß√µes em arquivos de build
if git diff --cached --name-only | grep -E "vite\.config\.ts$|tsconfig\.json$"; then
  echo -e "${YELLOW}‚ö†Ô∏è  Detectadas altera√ß√µes em arquivos de configura√ß√£o. Executando build de teste...${NC}"
  npm run build
else
  echo -e "${BLUE}‚ÑπÔ∏è  Nenhuma altera√ß√£o em arquivos de configura√ß√£o. Pulando build.${NC}"
fi

# Verificar vulnerabilidades em depend√™ncias
echo -e "${BLUE}üõ°Ô∏è Verificando vulnerabilidades em depend√™ncias...${NC}"
npm run security:audit || {
  echo -e "${YELLOW}‚ö†Ô∏è Detectadas vulnerabilidades em depend√™ncias. Por favor, revise e atualize as depend√™ncias afetadas.${NC}"
  # N√£o bloqueia o commit, mas alerta o desenvolvedor
}

echo -e "${GREEN}‚úÖ Pre-commit conclu√≠do com sucesso!${NC}"