name: Deploy to GitHub Pages

# Trigger do workflow
on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Permiss√µes necess√°rias
permissions:
  contents: write
  pages: write
  id-token: write

# Cancelar workflows anteriores se houver novo push
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do c√≥digo
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      # 3. Instalar depend√™ncias
      - name: üì¶ Install dependencies
        run: yarn install --frozen-lockfile

      # 4. Build da aplica√ß√£o
      - name: üî® Build application
        run: yarn build
        env:
          NODE_ENV: production

      # 5. Verificar arquivos cr√≠ticos de limpeza
      - name: üîç Verify cleanup files exist
        run: |
          echo "üîç Verificando presen√ßa dos arquivos de limpeza..."
          
          if [ ! -f "dist/sw-cleanup.js" ]; then
            echo "‚ùå ERRO: sw-cleanup.js n√£o encontrado em dist/!"
            echo "Este arquivo √© CR√çTICO para resolver o problema de tela branca."
            exit 1
          fi
          echo "‚úÖ sw-cleanup.js encontrado"
          
          if [ ! -f "dist/sw.js" ]; then
            echo "‚ùå ERRO: sw.js n√£o encontrado em dist/!"
            echo "Este arquivo √© necess√°rio para substituir o Service Worker antigo."
            exit 1
          fi
          echo "‚úÖ sw.js encontrado"
          
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERRO: index.html n√£o encontrado em dist/!"
            exit 1
          fi
          
          # Verificar se index.html cont√©m refer√™ncia ao script de limpeza
          if ! grep -q "sw-cleanup.js" "dist/index.html"; then
            echo "‚ö†Ô∏è WARNING: index.html n√£o referencia sw-cleanup.js!"
            echo "Isso pode causar problemas na limpeza do Service Worker."
          else
            echo "‚úÖ index.html cont√©m refer√™ncia ao sw-cleanup.js"
          fi
          
          echo "‚ú® Todos os arquivos cr√≠ticos verificados com sucesso!"

      # 6. Adicionar timestamp de build (cache busting)
      - name: ‚è±Ô∏è Add build timestamp
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "<!-- Build: $BUILD_TIME -->" >> dist/index.html
          echo "üìÖ Build timestamp: $BUILD_TIME"

      # 7. Listar arquivos gerados (debug)
      - name: üìÇ List generated files
        run: |
          echo "üìÇ Arquivos em dist/:"
          ls -lah dist/
          echo ""
          echo "üìä Tamanho do dist/:"
          du -sh dist/

      # 8. Deploy para GitHub Pages
      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
          cname: xperiencehubs.com
          commit_message: 'Deploy: ${{ github.event.head_commit.message }}'

      # 9. Sum√°rio do deploy
      - name: üìù Deployment summary
        if: success()
        run: |
          echo "‚úÖ ================================"
          echo "‚úÖ DEPLOY BEM-SUCEDIDO!"
          echo "‚úÖ ================================"
          echo ""
          echo "üåê Site: https://xperiencehubs.com"
          echo "üîß Commit: ${{ github.sha }}"
          echo "üìÖ Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "üßπ Arquivos de limpeza inclu√≠dos:"
          echo "   - sw-cleanup.js (remove SWs antigos)"
          echo "   - sw.js (Service Worker neutro)"
          echo ""
          echo "üëÅÔ∏è Para verificar:"
          echo "   1. Abra https://xperiencehubs.com"
          echo "   2. Abra DevTools (F12) > Console"
          echo "   3. Procure por mensagens 'üßπ Executando limpeza...'"
          echo "   4. Verifique Application > Service Workers"
          echo ""
          echo "‚ú® Service Worker antigo ser√° automaticamente removido!"

      # 10. Notificar em caso de falha
      - name: ‚ùå Deployment failed
        if: failure()
        run: |
          echo "‚ùå ================================"
          echo "‚ùå DEPLOY FALHOU!"
          echo "‚ùå ================================"
          echo ""
          echo "Verifique os logs acima para identificar o erro."
          echo "Problemas comuns:"
          echo "  - Falta de arquivos no public/"
          echo "  - Erro no build do Vite"
          echo "  - Problemas de permiss√£o"
          exit 1